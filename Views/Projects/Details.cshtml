@model BugHunterBugTrackerZD.Models.Project
@using BugHunterBugTrackerZD.Services.Interfaces

@inject IBTProjectService _ProjectService
@{
    ViewData["Title"] = "Details";
}



<style>
    .ck-editor__editable_inline {
        min-height: 200px;
    }

    input.largerCheckbox {
        width: 30px;
        height: 30px;
    }

    label.form-check-label {
        font-size: 22px;
    }
</style>


<div>

    <div class="container-fluid">
        <div class="row gy-2">
            <div class="col-6 col-md-12">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card m-1 p-2">
                            <div class="card-body">
                                @* Project Name *@
                                <h4>Project Description</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-9">
                        <div class="card m-1 p-2">
                            <div class="card-body">
                                @* Project Description *@
                                <textarea class="editor">@Model.Description</textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="row gy-2">
            <div class="col-md-12 col-6">
                <div class="row">
                    <div class="col-md-6">
                        <div class="card m-1 p-2">
                            <div class="card-body">
                                <div class="progress-container progress-info m-b-25">
                                    <span class="progress-badge" style="font-size:small">Project Status</span>
                                    <div class="progress mt-5">
                                        @* Razor code block *@
                                        @{
                                            var start = Model.StartDate;
                                            var end = Model.EndDate!.Value;
                                            var today = DateTime.Now;
                                            var percent = today >= end ? 100 : today < start ? 0 : Math.Round((today.Subtract(start!.Value)) / (end.Subtract(start.Value)) * 100);
                                        }
                                        <div class="progress-bar" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width: @percent%;">
                                            @* Use Progress Bar code variable here *@
                                            <span class="progress-value">@percent%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                    <div class="col-md-6">
                        <div class="card m-1 p-2">
                            <div class="card-body">
                                <ul class=" list-unstyled basic-list">
                                    <li class="text-dark">Start Date: <span class="text-dark">[@Model.StartDate]</span></li>
                                    <li class="text-dark">Deadline: <span class="text-dark">[@Model.EndDate]</span></li>
                                    <li class="text-dark">Priority: <span class="text-dark">[@Model.ProjectPriority!.Name]</span></li>
                                    @* if() logic *@
                                    [Project Active/Inactive]
                                </ul>
                            </div>
                    </div>
                </div>
                </div>
            </div>
        </div>

        <div class="row gy-2">
            <div class="col-6 col-md-12">
                <div class="row">
                    <div class="col-md-4">
                        <div class="">
                            <div class="card m-1 p-2">
                                <div class="">
                                    <h2>Project Manager</h2>
                                    <hr />
                                </div>
                                <div class="card-body" style="overflow-y:auto;height:300px;">
                                    @{
                                        BTUser? projectManager = await _ProjectService.GetProjectManagerAsync(Model.Id);
                                    }

                                    @((projectManager?.FullName ?? "Unassigned"))
                                    @* if() logic for Avatar/Default etc *@

                                   @* <figure class="profile-picture">
                                        @if (member.ImageFormFile != null)
                                        {

                                        }
                                        <img src="/img/DefaultUserImage.png" alt="@projectManager?.FullName" class="rounded-circle" data-lock-picture="/img/DefaultUserImage.png" height="35" />
                                        <span class="name ms-2">@projectManager?.FullName</span>
                                    </figure>*@

                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="">
                            <div class="card m-1 p-2">
                                <div class="">
                                    <h2>Project Team</h2>
                                    <hr />
                                </div>
                                <div class="card-body" style="overflow-y:auto;height:300px;">
                                    <ul class="right_chat list-unstyled mb-0 text-dark">
                                        @* Logic for avatars *@
                                        @foreach (BTUser member in Model.Members)
                                        {
                                            @* TODO: Add if() statement for adding avatar next to name using imageFormFile *@
                                            <li>
                                                <figure class="profile-picture">
                                                    @*@if (member.ImageFormFile != null)
                                                {

                                                }*@
                                                    <img src="/img/DefaultUserImage.png" alt="@member?.FullName" class="rounded-circle" data-lock-picture="/img/DefaultUserImage.png" height="35" />
                                                    <span class="name ms-2">@member?.FullName</span>
                                                </figure>

                                            </li>
                                            @*<li class="text-dark">
                                        @member.FullName
                                        </li>*@
                                        }
                                    </ul>

                                </div>
                            </div>

                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="">
                            <div class="card m-1 p-2">
                                <div class="">
                                    <h2>Project Activity</h2>
                                    <hr />
                                </div>
                                <div class="card-body" style="overflow-y:auto;height:300px;">
                                    @* Project Activity loop *@
                                    [Project Activity  e.g. Ticket History]

                                    <div class="timeline">
                                        <div class="tm-body">
                                            @foreach (Ticket ticket in Model.Tickets)
                                            {
                                                @foreach (var hList in ticket.History!.GroupBy(h => h.Created.Month))
                                                {
                                                    <div class="tm-title">
                                                        <h5 class="m-0 pt-2 pb-2 text-dark font-weight-semibold text-uppercase">@(hList.Select(h => h.Created).FirstOrDefault().ToString("MMMM yyyy"))</h5>
                                                    </div>
                                                    <ol class="tm-items">
                                                        @foreach (TicketHistory history in hList)
                                                        {
                                                            <li>
                                                                <div class="tm-info">
                                                                    <div class="tm-icon"><i class="fas fa-star"></i></div>
                                                                    <time class="tm-datetime" datetime="@history.Created.ToString("yyyy-MM-dd hh:mm")">
                                                                        @{
                                                                            DateTime hDate = history.Created;
                                                                        }
                                                                        <div class="tm-datetime-date">@(((today.Year - hDate.Year) * 12) + today.Month - hDate.Month) months ago</div>
                                                                        <div class="tm-datetime-time">@hDate.ToString("hh:mm tt")</div>
                                                                    </time>
                                                                </div>
                                                                <div class="tm-box" data-appear-animation="fadeInRight" data-appear-animation-delay="100">
                                                                    <p>
                                                                        @*@history.Description*@
                                                                    </p>
                                                                    <div class="tm-meta">
                                                                        <span>By: <a href="javascript:void(0);" title="@history.User?.FullName">@history.User?.FullName</a></span>

                                                                        <div class="msg">

                                                                            <p>The ticket <b>@history.PropertyName</b>  was edited</p>

                                                                            <p>@($"Previous {history.PropertyName}:  {history.OldValue}")</p>

                                                                            <p>@($"Current {history.PropertyName}:  {history.NewValue}")</p>



                                                                            <div class="media">

                                                                                @*<img class="media-object rounded width40 mr-3" src="~/assets/images/xs/pngegg-26.png" alt="" />*@

                                                                                <div class="media-body">

                                                                                    <h6 class="mb-0"></h6>

                                                                                </div>

                                                                            </div>



                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </li>
                                                        }
                                                    </ol>
                                                }
                                            }



                                        </div>
                                    </div>

                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row gy-2">
            <div class="col-6 col-md-12">
                @*<div class="mt-5 bg-primary">*@
                    <div class="card col-12 m-1 p-2">
                        <div class="">
                            <h2>@Model.Name - Tickets</h2>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive" @*style="overflow-y:auto;height:600px;"*@>
                                <table class="table table-bordered table-striped" id="datatable-default">
                                    <thead>
                                        <tr>
                                            @* Table header *@
                                            <th>
                                                Title
                                            </th>
                                            <th>
                                                Project
                                            </th>
                                            <th>
                                                Created / Updated
                                            </th>                                                                                        
                                            <th>
                                              Ticket Priority
                                            </th>
                                            <th>
                                                Ticket Type
                                            </th>
                                            <th>
                                                Ticket Status
                                            </th>
                                            <th>                                               
                                                Developer
                                            </th>
                                            <th>
                                                Submitter
                                            </th>
                                            <th>
                                                Actions
                                            </th>
                                           
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @* Table body *@                                    
                                        @foreach (Ticket ticket in Model.Tickets)
                                        {
                                            if (ticket.Archived == false)
                                            {
                                                <tr>
                                                    <td>
                                                        @ticket.Title
                                                    </td>
                                                    <td>
                                                        @ticket.Project!.Name
                                                    </td>
                                                    <td>
                                                        @Html.DisplayFor(modelItem => ticket.Created)
                                                        @if (ticket.Updated != null)
                                                        {
                                                            <span class="fw-bold">/</span>  @Html.DisplayFor(modelItem => ticket.Updated)
                                                        }
                                                    </td>                                                    
                                                    <td>
                                                        @ticket.TicketPriority!.Name
                                                    </td>
                                                    <td>
                                                        @ticket.TicketType!.Name
                                                    </td>
                                                    <td>
                                                        @ticket.TicketStatus!.Name
                                                    </td>
                                                    <td>
                                                        @if (ticket.DeveloperUser == null)
                                                        {
                                                            <span class="text-danger">Unassigned</span>
                                                        }
                                                        else
                                                        {
                                                           @ticket.DeveloperUser.FullName 
                                                        }
                                                    </td>
                                                    <td>
                                                        @ticket.SubmitterUser!.FullName
                                                    </td>
                                                    <td colspan="2" class="actions-hover actions-fade">
                                                        <a asp-action="Edit" asp-controller="Tickets" asp-route-id="@ticket.Id"> <i class="fas fa-pencil-alt"></i> </a>
                                                        <a asp-action="Details" asp-controller="Tickets" asp-route-id="@ticket.Id"> <i class='bx bx-detail'></i> </a>
                                                        <a asp-action="Delete" asp-controller="Tickets" asp-route-id="@ticket.Id" class="delete-row"> <i class="far fa-trash-alt"></i> </a>
                                                    </td>

                                                </tr>
                                            }

                                        }
                                    </tbody>
                                </table>
                            </div>

                        </div>
                  @*  </div>*@

                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {

    <!-- Specific Page Vendor -->
    <script src="~/template/vendor/select2/js/select2.js"></script>
    <script src="~/template/vendor/datatables/media/js/jquery.dataTables.min.js"></script>
    <script src="~/template/vendor/datatables/media/js/dataTables.bootstrap5.min.js"></script>
    <script src="~/template/vendor/datatables/extras/TableTools/Buttons-1.4.2/js/dataTables.buttons.min.js"></script>
    <script src="~/template/vendor/datatables/extras/TableTools/Buttons-1.4.2/js/buttons.bootstrap4.min.js"></script>
    <script src="~/template/vendor/datatables/extras/TableTools/Buttons-1.4.2/js/buttons.html5.min.js"></script>
    <script src="~/template/vendor/datatables/extras/TableTools/Buttons-1.4.2/js/buttons.print.min.js"></script>
    <script src="~/template/vendor/datatables/extras/TableTools/JSZip-2.5.0/jszip.min.js"></script>
    <script src="~/template/vendor/datatables/extras/TableTools/pdfmake-0.1.32/pdfmake.min.js"></script>
    <script src="~/template/vendor/datatables/extras/TableTools/pdfmake-0.1.32/vfs_fonts.js"></script>

    <!-- Examples -->
    <script src="~/template/js/examples/examples.datatables.default.js"></script>
    <script src="~/template/js/examples/examples.datatables.row.with.details.js"></script>
    <script src="~/template/js/examples/examples.datatables.tabletools.js"></script>


    <script src="~/ckeditor5/build/ckeditor.js"></script>

    <script>
        ClassicEditor
            .create(document.querySelector('.editor'), {
                licenseKey: '',
            })
            .then(editor => {
                window.editor = editor;
            })
            .catch(error => {
                console.error('Oops, something went wrong!');
                console.error('Please, report the following error on https://github.com/ckeditor/ckeditor5/issues with the build id and the error stack trace:');
                console.warn('Build id: xx09iayzufkn-lkt434h3lx2z');
                console.error(error);
            });
    </script>

   
}                                                       